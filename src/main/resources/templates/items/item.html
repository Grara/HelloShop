<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header"/>
<body>
<div class="container">
    <div th:replace="fragments/bodyHeader :: bodyHeader"/>
    <div>
        <img th:src="|/images/${fileId}|" width="150" height="150">
    </div>
    <div id="itemAttr">
        <input type="hidden" readonly th:value="${itemForm.id}"/>
        <p th:text="'상품명 : ' + ${itemForm.itemName}" th:value="${itemForm.itemName}"/>
        <p th:text="'저자 : ' + ${itemForm.author}"/>
        <p th:text="'설명 : ' + ${itemForm.description}"/>
        <p th:text="'가격 : ' + ${itemForm.price}" th:value="${itemForm.price}"/>
    </div>

    <div align="center">
        <div>
            <input type="number" style="width:50px" min="1" id="count" value="1">
        </div>
        <div style="float: left; width: 50%; padding:10px;" align="right">
            <a href="#" th:data-username="${userName}"
               th:onClick="buy(this.getAttribute('data-username'))"
               class="btn btn-primary">바로 구매</a>
        </div>
        <div style="float: left; width: 50%; padding:10px;" align="left">
            <a href="#" th:data-user="${userName}" th:data-id="${itemForm.id}"
               th:onClick="addItemToCart(this.getAttribute('data-user'), this.getAttribute('data-id'))"
               class="btn btn-primary">장바구니에 추가</a>
        </div>
    </div>
    <form role="form" th:object="${commentForm}">
        <div class="form-group">
            <label>후기 쓰기</label>
            <input id="itemId" type="hidden" th:field="*{itemId}">
            <input id="commentContent" type="text" th:field="*{content}" class="form-control" placeholder="내용을 입력하세요">
        </div>
        <button type="button" th:onclick="addComment()" class="btn btn-primary">작성</button>
    </form>
    <div style="margin:5px">
        <span th:text="|후기(|"/>
        <span id="commentsCount" th:text="${#lists.size(comments)}"/>
        <span th:text="|)|"/>
    </div>
    <div id="commentParent">
        <div th:each="comment : ${comments}">
            <hr>
            <span th:text="${comment.userName} + ' / '"/>
            <span th:text="${comment.lastModifiedDateTime} + ' / '"/>
            <span th:text="${comment.content}"/>
        </div>
    </div>
    <hr>
    <div th:replace="fragments/footer :: footer"/>
</div> <!-- /container -->
</body>
<script src="https://code.jquery.com/jquery-3.6.1.min.js"
        integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
<script th:inline="javascript">
function buy(name){
    var orderCount = document.getElementById("count").value;
    var items = new Array();
    var item = {};
    $('#itemAttr').each(function(){
        item.itemId = $(this).children().eq(0).val();
        item.itemName = $(this).children().eq(1).attr('value');
        item.price = $(this).children().eq(4).attr('value');
        item.count = orderCount;
        item.totalPrice = item.price * item.count;
        items.push(item);
    });

    var form = {
      "userName" : name,
      "items" : items
    }

    $.ajax({

    type : 'post',
    url : "/orderSheet/new",
    headers : {
        "Content-Type" : "application/json",
        "X-HTTP-Method-Override" : "POST"
    },
    dataType : 'json',
    data : JSON.stringify(form),
    success : function(res){
        window.location.href = 'http://localhost:8080/orderSheet/' + res;
    },
    failure : function(){
        alert("서버와의 통신에 실패했습니다.");
    }

    });

    return false;

}

function addItemToCart(username, itemId) {

var count = document.getElementById("count").value;

    var form = {
        "userName" : username,
        "itemId" : itemId,
        "count" : count
    };

    $.ajax({

    type : 'post',
    url : '/cart/new',
    headers : {
        "Content-Type" : "application/json",
        "X-HTTP-Method-Override" : "POST"
    },
    dataType : 'json',
    data : JSON.stringify(form),
    success : function(){
        if(confirm("장바구니로 이동하시겠습니까?")){
            window.location.href = "http://localhost:8080/cart";
        }
        else{
            return false;
        }
    },
    failure : function(){
        alert("서버와의 통신에 실패했습니다.");
    }

    });

}

function addComment(){

    var form = {
        'itemId' : $('#itemId').val(),
        'content' : $('#commentContent').val()
    }

    $.ajax({

    type : 'post',
    url : '/comments/new',
    headers : {
        "Content-Type" : "application/json",
        "X-HTTP-Method-Override" : "POST"
    },
    dataType : 'json',
    data : JSON.stringify(form),
    success : function(res){
        var div = $('<div>');
        $('#commentParent').append(div);
        $('<hr>').appendTo(div);
        $('<span>').text(res.userName + ' / ').appendTo(div);
        $('<span>').text(res.lastModifiedDateTime + ' / ').appendTo(div);
        $('<span>').text(res.content).appendTo(div);
        $('#commentContent').val('');
        let count = parseInt($('#commentsCount').html());
        $('#commentsCount').html(count + 1);
    },
    failure : function(){
        alert("서버와의 통신에 실패했습니다.");
    }

    });

}


</script>
</html>